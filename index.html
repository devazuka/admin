<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'><path fill='%23fff' stroke='%23888' d='M39,1L20.5,11L20.5,39L39,29Z'/><path fill='%23888' stroke='%23fff' d='M1,1L19.5,11L19.5,39L1,29Z'/></svg>">
  <title>Admin</title>
<style>
/* css patterns */
.p-checks-sm{background-image:repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor),repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor);background-position:0 0,10px 10px;background-size:calc(2 * 10px) calc(2 * 10px)}
.p-checks-md{background-image:repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor),repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor);background-position:0 0,25px 25px;background-size:calc(2 * 25px) calc(2 * 25px)}
.p-checks-lg{background-image:repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor),repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor);background-position:0 0,50px 50px;background-size:calc(2 * 50px) calc(2 * 50px)}
.p-checks-xl{background-image:repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor),repeating-linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%, currentColor);background-position:0 0,100px 100px;background-size:calc(2 * 100px) calc(2 * 100px)}
.p-grid-sm{background-image:linear-gradient(currentColor 1px, transparent 1px),linear-gradient(to right, currentColor 1px, transparent 1px);background-size:10px 10px}
.p-grid-md{background-image:linear-gradient(currentColor 1px, transparent 1px),linear-gradient(to right, currentColor 1px, transparent 1px);background-size:25px 25px}
.p-grid-lg{background-image:linear-gradient(currentColor 1px, transparent 1px),linear-gradient(to right, currentColor 1px, transparent 1px);background-size:50px 50px}
.p-grid-xl{background-image:linear-gradient(currentColor 1px, transparent 1px),linear-gradient(to right, currentColor 1px, transparent 1px);background-size:100px 100px}
.p-dots-sm{background-image:radial-gradient(currentColor .5px, transparent .5px);background-size:calc(10 * .5px) calc(10 * .5px)}
.p-dots-md{background-image:radial-gradient(currentColor 1px, transparent 1px);background-size:calc(10 * 1px) calc(10 * 1px)}
.p-dots-lg{background-image:radial-gradient(currentColor 1.5px, transparent 1.5px);background-size:calc(10 * 1.5px) calc(10 * 1.5px)}
.p-dots-xl{background-image:radial-gradient(currentColor 2px, transparent 2px);background-size:calc(10 * 2px) calc(10 * 2px)}
.p-cross-dots-sm{background-image:radial-gradient(currentColor .5px, transparent .5px),radial-gradient(currentColor .5px, transparent .5px);background-size:calc(20 * .5px) calc(20 * .5px);background-position:0 0,calc(10 * .5px) calc(10 * .5px)}
.p-cross-dots-md{background-image:radial-gradient(currentColor 1px, transparent 1px),radial-gradient(currentColor 1px, transparent 1px);background-size:calc(20 * 1px) calc(20 * 1px);background-position:0 0,calc(10 * 1px) calc(10 * 1px)}
.p-cross-dots-lg{background-image:radial-gradient(currentColor 1.5px, transparent 1.5px),radial-gradient(currentColor 1.5px, transparent 1.5px);background-size:calc(20 * 1.5px) calc(20 * 1.5px);background-position:0 0,calc(10 * 1.5px) calc(10 * 1.5px)}
.p-cross-dots-xl{background-image:radial-gradient(currentColor 2px, transparent 2px),radial-gradient(currentColor 2px, transparent 2px);background-size:calc(20 * 2px) calc(20 * 2px);background-position:0 0,calc(10 * 2px) calc(10 * 2px)}
.p-vertical-lines-sm{background-image:repeating-linear-gradient(to right, currentColor, currentColor 1px, transparent 1px, transparent);background-size:10px 10px}
.p-horizontal-lines-sm{background-image:repeating-linear-gradient(0deg, currentColor, currentColor 1px, transparent 1px, transparent);background-size:10px 10px}
.p-diagonal-lines-sm{background-image:repeating-linear-gradient(45deg, currentColor 0, currentColor 1px, transparent 0, transparent 50%);background-size:10px 10px}
.p-vertical-lines-md{background-image:repeating-linear-gradient(to right, currentColor, currentColor 1px, transparent 1px, transparent);background-size:25px 25px}
.p-horizontal-lines-md{background-image:repeating-linear-gradient(0deg, currentColor, currentColor 1px, transparent 1px, transparent);background-size:25px 25px}
.p-diagonal-lines-md{background-image:repeating-linear-gradient(45deg, currentColor 0, currentColor 1px, transparent 0, transparent 50%);background-size:25px 25px}
.p-vertical-lines-lg{background-image:repeating-linear-gradient(to right, currentColor, currentColor 1px, transparent 1px, transparent);background-size:50px 50px}
.p-horizontal-lines-lg{background-image:repeating-linear-gradient(0deg, currentColor, currentColor 1px, transparent 1px, transparent);background-size:50px 50px}
.p-diagonal-lines-lg{background-image:repeating-linear-gradient(45deg, currentColor 0, currentColor 1px, transparent 0, transparent 50%);background-size:50px 50px}
.p-vertical-lines-xl{background-image:repeating-linear-gradient(to right, currentColor, currentColor 1px, transparent 1px, transparent);background-size:100px 100px}
.p-horizontal-lines-xl{background-image:repeating-linear-gradient(0deg, currentColor, currentColor 1px, transparent 1px, transparent);background-size:100px 100px}
.p-diagonal-lines-xl{background-image:repeating-linear-gradient(45deg, currentColor 0, currentColor 1px, transparent 0, transparent 50%);background-size:100px 100px}
.p-vertical-stripes-sm{background-image:linear-gradient(90deg, transparent 50%, currentColor 50%);background-size:10px 10px}
.p-horizontal-stripes-sm{background-image:linear-gradient(0deg, transparent 50%, currentColor 50%);background-size:10px 10px}
.p-diagonal-stripes-sm{background:repeating-linear-gradient(45deg, transparent, transparent 10px, currentColor 10px, currentColor calc(2 * 10px))}
.p-vertical-stripes-md{background-image:linear-gradient(90deg, transparent 50%, currentColor 50%);background-size:25px 25px}
.p-horizontal-stripes-md{background-image:linear-gradient(0deg, transparent 50%, currentColor 50%);background-size:25px 25px}
.p-diagonal-stripes-md{background:repeating-linear-gradient(45deg, transparent, transparent 25px, currentColor 25px, currentColor calc(2 * 25px))}
.p-vertical-stripes-lg{background-image:linear-gradient(90deg, transparent 50%, currentColor 50%);background-size:50px 50px}
.p-horizontal-stripes-lg{background-image:linear-gradient(0deg, transparent 50%, currentColor 50%);background-size:50px 50px}
.p-diagonal-stripes-lg{background:repeating-linear-gradient(45deg, transparent, transparent 50px, currentColor 50px, currentColor calc(2 * 50px))}
.p-vertical-stripes-xl{background-image:linear-gradient(90deg, transparent 50%, currentColor 50%);background-size:100px 100px}
.p-horizontal-stripes-xl{background-image:linear-gradient(0deg, transparent 50%, currentColor 50%);background-size:100px 100px}
.p-diagonal-stripes-xl{background:repeating-linear-gradient(45deg, transparent, transparent 100px, currentColor 100px, currentColor calc(2 * 100px))}
.p-zigzag-sm{background:linear-gradient(135deg, currentColor 25%, transparent 25%) -10px 0,linear-gradient(225deg, currentColor 25%, transparent 25%) -10px 0,linear-gradient(315deg, currentColor 25%, transparent 25%),linear-gradient(45deg, currentColor 25%, transparent 25%);background-size:calc(2 * 10px) calc(2 * 10px)}
.p-zigzag-md{background:linear-gradient(135deg, currentColor 25%, transparent 25%) -25px 0,linear-gradient(225deg, currentColor 25%, transparent 25%) -25px 0,linear-gradient(315deg, currentColor 25%, transparent 25%),linear-gradient(45deg, currentColor 25%, transparent 25%);background-size:calc(2 * 25px) calc(2 * 25px)}
.p-zigzag-lg{background:linear-gradient(135deg, currentColor 25%, transparent 25%) -50px 0,linear-gradient(225deg, currentColor 25%, transparent 25%) -50px 0,linear-gradient(315deg, currentColor 25%, transparent 25%),linear-gradient(45deg, currentColor 25%, transparent 25%);background-size:calc(2 * 50px) calc(2 * 50px)}
.p-zigzag-xl{background:linear-gradient(135deg, currentColor 25%, transparent 25%) -100px 0,linear-gradient(225deg, currentColor 25%, transparent 25%) -100px 0,linear-gradient(315deg, currentColor 25%, transparent 25%),linear-gradient(45deg, currentColor 25%, transparent 25%);background-size:calc(2 * 100px) calc(2 * 100px)}
.p-triangles-sm{background-image:linear-gradient(45deg, currentColor 50%, transparent 50%);background-size:10px 10px}
.p-triangles-md{background-image:linear-gradient(45deg, currentColor 50%, transparent 50%);background-size:25px 25px}
.p-triangles-lg{background-image:linear-gradient(45deg, currentColor 50%, transparent 50%);background-size:50px 50px}
.p-triangles-xl{background-image:linear-gradient(45deg, currentColor 50%, transparent 50%);background-size:100px 100px}
</style>
<style>
/* latin */
@font-face {
  font-family: 'Inconsolata';
  font-style: normal;
  font-weight: 400;
  font-stretch: 75%;
  src: url(https://fonts.gstatic.com/s/inconsolata/v30/QldgNThLqRwH-OJ1UHjlKENVzkWGVkL3GZQmXQLYxYWI2qfdm7Lpp4U8WR32lw.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

/* latin */
@font-face {
  font-family: 'Inconsolata';
  font-style: normal;
  font-weight: 400;
  src: url(https://fonts.gstatic.com/s/inconsolata/v30/QlddNThLqRwH-OJ1UHjlKENVzlm-WkL3GZQmAwPyya15.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
body {
  margin: 0 auto;
}

body, span, button, input, textarea {
  font-family: 'Inconsolata', monospace;
}

button, input, textarea {
  font-size: 1em;
  padding: 0.25em 0.5em;
}

h1 { text-align: center }
.data {
  display: grid;
  border-right: 1px solid black;
}

.data > b[data-sort=asc] {
  background:
    linear-gradient(45deg, transparent 25%, #70f 0), 
    linear-gradient(-45deg, transparent 80%, #70f 0),
    linear-gradient(to bottom, transparent 65%, #70f 65%),
    #fff;
}
.data > b[data-sort=desc] {
  color: black;
  background:
    linear-gradient(45deg, #f70 20%, transparent 0), 
    linear-gradient(-45deg, #f70 75%, transparent 0),
    linear-gradient(to top, transparent 65%, #f70 65%),
    #000;
}

.data > span.fullname, .data > span.guest { text-transform: capitalize }
.data > span.Boolean:after { content: '✘' }
.data > span.Boolean[data-val='true']:after { content: '✔' }
.data > span.Boolean.sex:after { content: '⚧️' }
.data > span.Boolean.sex[data-val='true']:after { content: '♂️' }
.data > span.Boolean.sex[data-val='false']:after { content: '♀️' }

.data > span, .data > b {
  padding: 8px 4px;
  white-space: nowrap;
  text-align: center;
  display: inline-flex;
  justify-content: center;
  align-items: center;
}
.data > span.Date, .data > b.sex {
  font-stretch: 75%;
}
.data > span {
  border-left: 1px solid black;
  border-bottom: 1px solid black;
}

.data > span.even {
  background: rgba(0,0,0,.1);
}

.data > span:target {
  background: #70f;
  color: white;
}

.data > span.empty:after { content: '-' }
.data > span.image { padding: 0 }
.data > span.image:hover > img {
  height: unset;
  width: unset;
  position: absolute;
  pointer-events: none;
}
.data > span.image > img { height: 4em; width: 4em; }
.data > span.image:not(.empty):hover { height: 4em; width: 4em; }

.data > b {
  background: black;
  color: white;
  user-select: none;
  cursor: default;
}

.data > *.hidden {
  width: 0px;
  overflow: hidden;
  border: 0;
  padding: 0;
  outline: none;
  margin-right: -1px;
}
main {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-evenly;
}
main.has-selection .data > span { display: none }
main.has-selection .data > span.selected { display: inline-flex }

input[value="person"][type="radio"]:checked {
  border: 2px solid red;
}

h3 { text-align: center }
h2 {
  text-align: center;
  color: white;
  background: black;
}

#add-links {
  display: grid;
  grid-template-columns: max-content;
  grid-gap: 0.25em;
}
#add-links button {
  width: 100%;
  text-align: left;
}

#actions { display: flex }

#referral-group {
  display: inline-flex;
  align-items: baseline;
}

#user-inputs .text > input, #user-inputs label > textarea {
  flex-grow: 1;
  margin: 0.5em 0.25em;
}
#user-inputs .text:focus-within > span {
  background: #70f;
}
.text div label { display: block; }
label { white-space: nowrap }
#user-inputs .text > span {
  flex-shrink: 0;
  width: 5em;
  text-align: right;
  color: white;
  background: black;
  padding: 0 0.25em;
  display: inline-flex;
  align-items: center;
  justify-content: end;
}
#user-inputs .text {
  display: flex;
  flex-direction: row;
}
#user-inputs button {
  margin: 0.5em 0 0 auto;
  white-space: nowrap;
  width: fit-content;
  flex-grow: 0;
  flex-shrink: 1;
}
#user-inputs {
  display: flex;
  flex-direction: column;
}
#user-actions[data-mode=create] .create-only { display: inherit }
#user-actions[data-mode=create] .edit-only { display: none }
#user-actions[data-mode=edit] .create-only { display: none }
#user-actions[data-mode=edit] .edit-only { display: inherit }
#user-actions[data-status=inactive] .active-only { display: none }
#user-actions[data-status=inactive] .active-only { display: inherit }
#user-actions[data-status=active] .inactive-only { display: inherit }
#user-actions[data-status=active] .inactive-only { display: none }
#user-actions-bar { display: flex; gap: 0.5em }
#active-visit {
  display: flex;
  flex-wrap: wrap;
}
#active-visit .visit button:hover,
#active-visit .visit button:focus,
#active-visit .visit button:active { opacity: 1 }
#active-visit .visit button {
  position: absolute;
  margin-left: 5em;
  border-radius: 100%;
  padding: 0.25em;
  opacity: 0.25;
}
#active-visit .visit img {
  width: 4em;
  height: 4em;
  border-radius: 50%;
}
#active-visit .visit span {
  text-transform: capitalize;
}
#active-visit .visit {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 1em;
}
</style>
</head>
<body>
  <h1>Admin</h1>
  <h2>Actions</h2>
  <div id="actions">
    <div id="user-actions" data-mode="create">
      <h3>👨‍💻 Users 👩‍💻</h3>
      <form id="user-inputs">
        <h4 class="create-only">🗃️ Register new user</h4>
        <h4 class="edit-only">🗃️ Edit existing user</h4>
        <label class="text edit-only"><span>_id:</span><input name="_id" type="number" readonly></label>
        <label class="text"><span>Email:</span><input name="email" type="email"></label>
        <label class="text"><span>Name:</span><input name="fullname"></label>
        <label class="text"><span>Image:</span><input name="image"></label>
        <label class="text"><span>Notes:</span><textarea name="notes"></textarea></label>
        <label class="text"><span>Birthday:</span><input name="birth" type="date"></label>
        <div class="text" style="display: flex; align-items: center">
          <span style="padding-top: 0.5em; padding-bottom: 0.5em;">Org:</span>
          <label style="margin-right: 0.5em"><input type="radio" name="org" value="" checked>None</label>
          <label style="margin-right: 0.5em"><input type="radio" name="org" value="01">01</label>
          <label><input type="radio" name="org" value="devazuka">DEVAZUKA</label>
        </div>
        <div class="text">
          <span>Referral:</span>
          <div>
            <label><input type="radio" name="referral" value="other" checked>Other</label>
            <label><input type="radio" name="referral" value="croissant">Croissant</label>
            <label><input type="radio" name="referral" value="instagram">Instagram</label>
            <label><input type="radio" name="referral" value="linkedin">Linkedin</label>
            <label><input type="radio" name="referral" value="facebook">Facebook</label>
            <label><input type="radio" name="referral" value="meetup">Meetup</label>
            <label><input type="radio" name="referral" value="tiktok">Tiktok</label>
            <label><input type="radio" name="referral" value="google">Google</label>
            <label><input type="radio" name="referral" value="map">Map</label>
            <div id="referral-group">
              <label><input type="radio" name="referral" value="person">Person:</label>
              <input name="referral-entity" class="person-input">
            </div>
          </div>
        </div>
        <div id="user-actions-bar">
          <button name="day_pass" type="button" class="edit-only">🕑 1 Day</button>
          <button name="month_pass" type="button" class="edit-only">🗓️ 30 Day</button>
          <button name="check-in" type="button" class="edit-only inactive-only">🛂 Check-in</button>
          <button name="add-user" class="create-only">⬆️ Create</button>
          <button name="update-user" class="edit-only">⬆️ Save changes</button>
        </div>
      </form>
      <div id="add-links">
        <h4 class="edit-only">🔗 Link with</h4>
        <h4 class="create-only">📂 Create from</h4>
        <!-- generate the list -->
      </div>
    </div>
    <div style="flex-grow: 1">
      <h3>⌛ Active Visits</h3>
      <div id="active-visit">
        <!--
          generate the list
          with button to check-out for managed visit (not croissant)
        <div>
          <button id="check-out">❌ check out</button>
          <button id="drink">🥤 drink</button>
        </div>
        -->
      </div>
    </div>
  </div>
  <h2>Data</h2>
  <main></main>
  <script>
const CONTENT = document.querySelector('main')

const randomSeed = ((r,a,n)=>(d,o,m,i,z,e,x)=>(o=n(3941471299,d),m=a(0.8633289230056107-(o>>>0)*r),i=a(0.15019597788341343-(o=n(o,d)>>>0)*r),z=a(0.9176952994894236-(o=n(o,d)>>>0)*r),e=1,()=>(x=2091639*m+e*r,m=i,i=z,z=x-(e=x|0))))(23283064365386963e-26,e=>e+(e<0),(e,r)=>{for(let t of r){let r=.02519603282416938*(e+=t.charCodeAt());r-=e=r>>>0,r*=e,r-=e=r>>>0,e+=4294967296*r}return e})
const parts = {
  types: ['checks', 'grid', 'dots', 'cross-dots', 'diagonal-lines', 'horizontal-lines', 'vertical-lines', 'diagonal-stripes', 'horizontal-lines', 'vertical-stripes', 'triangles', 'zigzag'],
  sizes: ['sm', 'md', 'lg', 'xl'],
}

const generatePattern = seed => {
  const rand = randomSeed(seed)
  const type = parts.types[~~(rand()*parts.types.length)]
  const size = parts.sizes[~~(rand()*parts.sizes.length)]
  const hue = rand()*360
  const fg = `hsl(${hue+90}, 70%, 90%)`
  const bg = `hsl(${hue}, 60%, 70%)`
  return { class: `p-${type}-${size}`, color: fg, backgroundColor: bg }
}

const f2 = n => n < 10 ? ('0'+n) : n
const units = [
  ['year', 31536000000],
  ['month', 2628000000],
  ['day', 86400000],
  ['hour', 3600000],
  ['minute', 60000],
  ['second', 1000],
]

const rtf = new Intl.RelativeTimeFormat('en', { style:'narrow'})
const relatime = elapsed => {
  for (const [unit, amount] of units) {
    if (Math.abs(elapsed) > amount || unit === 'second') {
      return rtf.format(Math.round(elapsed/amount), unit)
    }
  }
}

const call = f => f()
const everySecondSub = new Set
const triggerUpdates = () => {
  requestAnimationFrame(() => everySecondSub.forEach(call))
  setTimeout(triggerUpdates, 1000)
}
triggerUpdates()
const formatTime = (start, end) => {
  const elem = document.createElement('time')
  const d = new Date(start)
  const time = f2(d.getHours()) +':'+ f2(d.getMinutes()) +':'+ f2(d.getSeconds())
  const date = f2(d.getDate()) +'-'+ f2(d.getMonth()+1) +'-'+ f2(d.getFullYear())
  elem.title = (elem.dateTime = `${date} ${time}`)
  if (end) {
    const text = relatime(end - start)
    elem.append(text.slice(3, -1))
  } else {
    let prevValue = relatime(Date.now() - d.getTime())
    const text = document.createTextNode(prevValue)
    everySecondSub.add(() => {
      const value = relatime(d.getTime() - Date.now())
      if (value === prevValue) return
      text.nodeValue = (prevValue = value)
    })
    elem.append(text)
  }
  return elem
}
const columnTypeDefs = {
  Date: { format: ts => formatTime(ts) },
  String: { format: (s, name) => s == null ? undefined : String(s) },
  Number: { format: n => n == null ? undefined : String(n) },
  Boolean: { format: v => '', width: '2em' },
  JSON: { format: JSON.stringify },
}

const statusEmoji = { succeeded: '🟢', pending: '🟡', failed: '🔴' }
const specialColumns = {
  image: {
    format(src) {
      if (!src) return
      const pattern = generatePattern(src)
      const img = document.createElement('img')
      img.style.color = pattern.color
      img.style.backgroundColor = pattern.backgroundColor
      img.classList.add(pattern.class)
      img.src = src
      return img
    },
  },
  amount: {
    alias: '€',
    format: n => `${(n / 100)}€`,
  },
  refunded: { alias: '♻️' },
  disputed: { alias: '👩‍⚖️' },
  birth: {
    alias: 'age',
    format(v) {
      if (!v) return
      const time = document.createElement('time')
      const d = new Date(v)
      const date = f2(d.getDate()) +'-'+ f2(d.getMonth()+1) +'-'+ f2(d.getFullYear())
      time.title = (time.dateTime = `${date} 00:00:00`)
      time.append(Math.floor((Date.now() - d.getTime()) / (1000*60*60*24*365)))
      return time
    }
  },
  croissant: {
    alias: ' ',
    format(v) {
      if (!v) return '💳'
      const span = document.createElement('span')
      span.title = v
      span.append('🥐')
      return span
    }
  },
  createdAt: {
    // hidden: true,
    alias: 'saved',
  },
  updatedAt: {
    // hidden: true,
    alias: 'changed',
  },
  end: {
    alias: 'time',
    format(v, name, type, data) {
      const span = document.createElement('span')
      const duration = formatTime(data.at, v)
      span.append(v ? '' : '🟢 ', duration)
      return span
    }
  },
  tax: { hidden: true },
  type: { hidden: true },
  // product: { hidden: true },
  status: {
    alias: 'ok?',
    format(v) {
      const span = document.createElement('span')
      span.append(statusEmoji[v])
      span.title = v
      return span
    }
  },
  alias: { hidden: true },
  // id: { hidden: true },
}

const ENTITY = new Map()
const getAllRelated = (entity, collected = new Set) => {
  collected.add(entity)
  for (const id of entity.relateTo) {
    const relatedEntity = ENTITY.get(id)
    if (!relatedEntity || collected.has(relatedEntity)) continue
      getAllRelated(relatedEntity, collected)
  }
  return collected
}

const opClass = (entity, key, name) => entity && [...getAllRelated(entity)]
  .flatMap(e => e.elems)
  .forEach(elem => elem.classList[key](name))

let SELECTED_ENTITY
const handleUpdateHash = () => {
  const selected = location.hash.split(/^#select-([0-9]+)$/)[1]
  const entity = ENTITY.get(Number(selected))
  if (entity === SELECTED_ENTITY) return
  CONTENT.classList.toggle('has-selection', Boolean(entity))
  opClass(entity, 'add', 'selected')
  opClass(SELECTED_ENTITY, 'remove', 'selected')
  SELECTED_ENTITY = entity
  const { dataset } = userForm.parentElement
  if (entity?.entityType === 'person') {
    dataset.mode = 'edit'
    dataset.status = entity.active ? 'active' : 'inactive'
    setUserInputs(entity)
  } else {
    dataset.mode = 'create'
    dataset.status = 'inactive'
  }
}
addEventListener('hashchange', handleUpdateHash)

const entityDefs = {
  name: '#',
  format(v) {
    const a = document.createElement('a')
    const hash = `#select-${v}`
    a.href = hash
    a.onclick = (e) => {
      if (location.hash !== hash) return
      e.preventDefault()
      location.hash = '#'
    }
    a.append(`#${v}`)
    return a
  }
}

const refDefs = {
  isRef: true,
  format(v, name, type) {
    if (!v) return v
    const a = document.createElement('a')
    const b = document.createElement('b')
    b.append(v)
    a.append('#', b)
    a.href = `#${v}`
    a.title = `${type}#${v}`
    return a
  },
}

const prepareColumn = ([name, type], index) => {
  const def = index
    ? ({ ...(columnTypeDefs[type] || refDefs), ...specialColumns[name] })
    : entityDefs

  return { width: 'min-content', type, index, name, ...def }
}

const tableAliases = {
  coworker: '🥐 Croissant',
  client: '💳 Stripe',
  payment: '💰 Payments',
  person: '👥 Persons',
  visit: '🗺️ Visits'
}

// TODO: add filter
const makeFilter = q => new Function(['data', 'i', 'all'], `with (data) { return ${q} }`)

const birthInput = document.querySelector('input[name=birth]')
const yyyy = new Date().getFullYear()
const mmdd = `${f2(new Date().getMonth()+1)}-${f2(new Date().getDay())}`
birthInput.max = `${yyyy - 8}-${mmdd}`
birthInput.min = `${yyyy - 88}-${mmdd}`
birthInput.addEventListener('focus', e => {
  e.target.value || (e.target.value = '1999-06-25')
})
birthInput.addEventListener('blur', e => {
  e.target.value === '1999-06-25' && (e.target.value = '')
})
const createTable = (table, initialSort = {}) => {
  const wrapper = document.createElement('div')
  const title = document.createElement('h3')
  const div = document.createElement('div')
  const entityType = table.name
  wrapper.id = entityType
  title.append(tableAliases[entityType] || entityType)
  wrapper.append(title, div)
  div.classList.add('data')

  const columns = Object.entries(table.columns).map(prepareColumn)
  const size = columns.length
  div.classList.add(`column-${size}`)
  let sorts = initialSort
  for (const { name, type, alias, hidden } of columns) {
    const b = document.createElement('b')
    b.title = name
    b.classList.add(name, type)
    b.classList.toggle('hidden', Boolean(hidden))
    b.append(alias || name)
    b.addEventListener('click', () => {
      if (sorts.name !== name) {
        sorts.b && (sorts.b.dataset.sort = '')
        sorts.name = name
        sorts.b = b
      }
      sorts.order = b.dataset.sort =
          b.dataset.sort === 'asc' ? 'desc'
        : b.dataset.sort === 'desc' ? ''
        : 'asc'
      sort()
    })
    if (sorts.name === name) {
      b.dataset.sort = sorts.order
      sorts.b = b
    }
    div.append(b)
  }

  div.style.gridTemplateColumns = columns.map(c => c.width).join(' ')
  let row = -1, col = -1
  const rows = table.data
  const maxRow = rows.length
  const unsortedData = Array(maxRow)
  while (++row < maxRow) {
    const data = rows[row]
    col = -1
    const relateTo = new Set()
    const rowSpans = Array(size)
    const _id = data[0]
    const rowData = { _id, entityType, elems: rowSpans, relateTo }
    unsortedData[row] = rowData
    ENTITY.set(_id, rowData)
    while (++col < size) {
      const { name, format, type, isRef, hidden } = columns[col]
      const span = document.createElement('span')
      const val = data[col]
      isRef && relateTo.add(val)
      span.id = col ? `${name}-${_id}` : _id
      span.classList.add(name, type)
      span.classList.toggle('hidden', Boolean(hidden))
      span.dataset.val = val
      span.dataset.row = row
      span.dataset.col = col
      span.dataset.id = _id
      const formatted = format(val, name, type, rowData)
      formatted == null
        ? span.classList.add('empty')
        : span.append(formatted)
      rowData[name] = val
      rowSpans[col] = span
    }
  }
  const show = (data) => {
    const { length } = data
    let row = -1
    while (++row < maxRow) {
      const { elems } = data[row]
      const par = row % 2 ? 'odd' : 'even'
      let col = -1
      while (++col < size) {
        const elem = elems[col]
        elem.dataset.par = par
        div.append(elem)
      }
    }
  }

  const compare = orderCompare => (adata, bdata) => {
    const a = adata[sorts.name]
    const b = bdata[sorts.name]
    if (a == b) return 0
    if (a == null) return 1
    if (b == null) return -1
    return orderCompare(a, b)
  }

  const compareASC = compare((a, b) => String(a).localeCompare(b))
  const compareDESC = compare((a, b) => String(b).localeCompare(a))

  const sortedData = [...unsortedData] // preserve the original order
  const sort = () => show(sorts.name
    ? sortedData.sort(sorts.order === 'asc' ? compareASC : compareDESC)
    : unsortedData)
  sort()
  CONTENT.append(wrapper)
}

const buildRelation = () => {
  for (const [id, { relateTo }] of ENTITY) {
    for (const relatedId of relateTo) {
      ENTITY.get(relatedId)?.relateTo.add(id)
    }
  }
}

const initialSorts = {
  client: { name: 'fullname', order: 'asc' },
  coworker: { name: 'fullname', order: 'asc' },
  person: { name: 'fullname', order: 'asc' },
  visit: { name: 'at', order: 'desc' },
  payment: { name: 'at', order: 'desc' },
}

const formatPersonValues = data =>
  Object.fromEntries(Object.entries(data)
    .map(([k, v]) => {
      try {
        if (k === 'birth') return [k, new Date(v).getTime()]
      } catch { return [k] }
      // TODO: handle user referral
      if (k === 'referral') return [k, typeof v === "number" ? v : referrals[v]]
      if (k === 'name') return [k, v?.toLowerCase()]
      return [k, v]
    })
    .filter(([,v]) => v))



const referrals = {}
const userForm = document.querySelector('form#user-inputs')
const checkinButton = document.querySelector('button[name=check-in]')
checkinButton.addEventListener('click', async e => {
  e.preventDefault()
  if (SELECTED_ENTITY?.entityType !== 'person') return
  const res = await fetch('/api/checkin', {
    method: 'POST',
    body: JSON.stringify({ by: SELECTED_ENTITY._id })
  })
  res.ok && location.reload()
})

userForm.addEventListener('submit', async e => {
  e.preventDefault()
  const data = Object.fromEntries(new FormData(e.target))
  if (e.submitter.name === 'add-user') {
    data.link = data._id
    data._id = undefined
  }
  const values = formatPersonValues(data)
  const response = await fetch('/api/person', {
    method: 'POST',
    body: JSON.stringify(values)
  })
  response.ok && location.reload()
  // TODO: show error if any !
})

const userInputsList = [...document.querySelectorAll('#user-inputs *[name]')].reverse()
const userInputs = Object.fromEntries(userInputsList.map(i => [i.name, i]))
userInputs.referral = Object.fromEntries(
  userInputsList
    .filter(i => i.name === 'referral')
    .map(i => [i.value, i])
)
const setUserInputs = (initialValues = {}) => {
  for (const input of userInputsList) {
    if (initialValues[input.name]) continue
    if (input.type === 'radio') {
      input.checked = true
    } else {
      input.value = ''      
    }
  }
  for (const [key, value] of Object.entries(initialValues)) {
    if (!userInputs[key]) continue
    if (key === 'referral') {
      userInputs[key][referrals[value] || value].checked = true
    } else if (key === 'birth'){
      value
        ? (userInputs[key].valueAsNumber = value)
        : (userInputs[key].value = '')
    } else {
      userInputs[key].value = value
    }
  }
}

const generateActivePersonList = () => {
  const activeVisits = [...ENTITY.values()]
    .filter(e => e.entityType === 'visit')
    .filter(e => !e.end)

  const visitElements = []
  for (const visit of activeVisits) {
    const by = ENTITY.get(visit.by)
    const wrapper = document.createElement('div')
    const name = document.createElement('span')
    wrapper.classList.add('visit')
    const img = document.createElement('img')
    if (visit.guest) {
      // croissant guest mode
      wrapper.append(specialColumns.image.format(`https://robohash.org/${encodeURIComponent(visit.guest)}`))
      name.append(visit.guest)
    } else if (by?.entityType === 'coworker') {
      // croissant account unlinked yet
      wrapper.append(specialColumns.image.format(by.image || `https://robohash.org/${encodeURIComponent(by.fullname)}`))
      name.append(by.fullname)
    } else if (by?.entityType === 'person') {
      by.active = true
      wrapper.append(specialColumns.image.format(by.image))
      const a = document.createElement('a')
      a.href = `#select-${by._id}`
      a.append(by.fullname)
      name.append(a)
      if (!visit.id) { // visit.id means it's managed by croissant
        const checkoutButton = document.createElement('button')
        checkoutButton.append('❌')
        checkoutButton.title = 'checkout'
        checkoutButton.addEventListener('click', async e => {
          const res = await fetch('/api/checkout', {
            method: 'POST',
            body: JSON.stringify({ id: visit._id })
          })
          res.ok && location.reload()
        })
        wrapper.append(checkoutButton)
      }
    }
    wrapper.append(name)
    visitElements.push(wrapper)
  }

  document
    .querySelector('#active-visit')
    .append(...visitElements)
}

const buildLinks = () => {
  const links = [...ENTITY.values()]
    .filter(e => !e.is && (e.entityType === 'client' || e.entityType === 'coworker'))
    .map(e => {
      const wrapper = document.createElement('div')
      const create = document.createElement('button')
      const link = document.createElement('button')
      const name = e.fullname.replace(/\s+/g, '_')
      const icon = e.entityType === 'client' ? '💳' : '🥐'
      
      create.append(icon, name)
      create.title = e._id
      create.classList.add('create-only')
      create.addEventListener('click', event => {
        event.preventDefault()
        setUserInputs({ ...e, referral: icon === '🥐' ? 'croissant' : 'other' })
      })
      link.append(icon, name)
      link.title = e._id
      link.classList.add('edit-only')
      link.addEventListener('click', async event => {
        event.preventDefault()
        if (!SELECTED_ENTITY) return // TODO: show error
        link.disabled = true
        const values = {
          ...formatPersonValues(e),
          ...formatPersonValues(SELECTED_ENTITY),
          link: e._id,
        }
        const res = await fetch(`/api/person`, {
          method: 'POST',
          body: JSON.stringify(values)
        })
        res.ok && location.reload()
        // TODO: handle errors
      })

      wrapper.append(create, link)
      return wrapper
    })

  document.querySelector('#add-links').append(...links)
}

fetch('/api/all').then(r => r.json()).then(tables => {
  for (const [name, { definitions, values }] of Object.entries(tables)) {
    if (name === 'product') continue
    if (name === 'referral') {
      for (const [id, key] of values) {
        referrals[key] = id
        referrals[id] = key
      }
      continue
    }
    createTable({
      name,
      columns: definitions,
      data: values,
    }, initialSorts[name])
  }
  generateActivePersonList()
  buildRelation()
  handleUpdateHash()
  buildLinks()
})

  </script>
</body>
</html>
